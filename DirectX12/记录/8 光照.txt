8.1 光照与材质的交互
在开启光照的同时，我们不再直接指出顶点的颜色，而是指定材质与光照，再运用光照方程基于两者的交互来计算顶点颜色。
我们可以把材质看作是确定光照与物体表面如何进行交互的属性集。
此属性集中的属性有：表面反射光和吸收光的颜色，表面下材质的折射率，表面的光滑度以及表面的透明度。
当光线从光源发出向外传播并触碰到某个物体时，一部分光线可能会被吸收，而另一部分光线将会被反射。被反射的光线会沿着它的新路径传播，并有可能再次碰到其他物体，发生二次吸收与反射。因此，还会发生这样一种情况，那就是在光线在碰到足够多的物体后被吸收，而一些剩余的光线最终可能会传入观察者的眼中。
视网膜含有三种受光体，分别对于红绿蓝光敏感。
本书中所采用的光照模型均为局部光照模型。使用这种模型，每个物体的光照皆独立于其他物体，我们就可以在处理光照的过程中仅考虑光源直接发出的光线(即在处理当前的物体光照时，忽略来自场景中其他物体说反弹来的光)。
全局光照模型除了要考虑由光源直接发出的光，还要顾及场景中其他物体反弹来的间接光照。另一种流行的方法是预计算静态物体的间接光照。

8.2 法向量
平面法线是一种描述多边形朝向的单位向量。
根据曲面法线即可确定对应曲面上某点的朝向。
为了求出曲面法线，我们仅先指定位于网格顶点处的曲面法线(也称为顶点法线)，接下来，为取得三角形网格曲面上每个点处的近似曲面法线，在三角形进行光栅化的过程中对这些顶点法线进行插值计算。

8.2.1 计算法向量
为了找到三角形p0p1p2的平面法线，我们首先计算位于三角形边上的两个向量：
u = p1 - p0; v = p2 - p0;
那么此三角形的平面法线即为:
n = u x v / |u x v|
对于可微的光滑曲面而言，我们可以利用微积分方面的知识来求出曲面点处的法线。
但问题在于，三角形网格运用一种被称为求顶点法线平均值的计算方法。此方法通过对网格中共享顶点v的多边形的平面法线求取平均值，从而获得网格中任意顶点v处的顶点法线n。
navg = (n0 + n1 + n2 + n3)/|n0 + n1 + n2 + n3|
为了获得更为精确的结果，我们还可以采用更加复杂的求平均值方法，比如说，根据多边形的面积来确定权重，以求取加权平均值。
(实现代码)

8.2.2 变换法向量
若给定一个用于变换点与向量的变换矩阵A，如何能够求出这样一个变换矩阵B：通过它来变换法向量，使经矩阵A变换后的切向量与法向量重归正交关系。
B = (A-1)T(推导过程见书本)
如果矩阵A是正交矩阵，那么B=A。

8.3 参与光照计算的一些关键向量

8.4 朗伯余弦定律
我们可以将光看作是光子的集合，在空间中按特定的方向传播。每个光子都载有能量。光源每秒发出的能量称为辐射通量。
单位面积上的辐射通量密度称为辐照度。
光线垂直照射到表面的强度要大于以某个角度照射到表面的强度。
面积A2内的辐照度就相当于将受垂直方向光照的面积A1内的辐照度按比例n*L=cosA进行缩放。这就是传说中的朗伯余弦定律。
考虑到光线照射到表面另一侧的情况，我们用max函数来限制缩放因子的取值范围：f(A) = max(cosA, 0) = max( L.n, 0)

8.5 漫反射光照
当光线照射到表面上的某一点时，一部分光会进入物体的内部，并与表面附近的物质相互作用。这些光会在物体内部四处反弹，其中一部分会被吸收，而余下部分会向各个方向散射并返回表面，这就是所谓的漫反射。
漫反射光照的计算与观察点无关。
(漫反射光量计算公式)

8.6 环境光照
(环境光计算公式)

8.7 镜面反射
如果折射光沿折射向量从介质的另一侧射出，并进入观察者的眼中，则该物体看起来就像是透明的。
与漫反射光相比，镜面光可能并不会射入观察者的眼内，因为其反射只发生在某一特定角度。也就是说，镜面光照的计算与观察点有关。
同时，这意味着随着观察位置在场景中的移动，它所收到的镜面光亮也随之发生改变。

8.7.1 菲涅尔效应
菲涅尔方程以数学方法描述了入射光线被反射的百分比，即0<=RF<=1。
根据能量守恒定律，如果RF是反射光量，则(1-RF)为折射光量。RF的值是一个RGB向量，因为光的颜色反映了反射光量。
反射的光量既依赖于介质也与法向量n和光向量L之间的夹角有关。
由于光照过程的复杂性，我们一般不会将完整的菲涅尔方程用于实时渲染，而是采用石里克近似法来加以代替：
(公式)
(石里克近似曲线图)
(菲涅尔效应的概念)
可以将菲涅尔效应简介地概括为：反射光量取决于材质以及法线与光向量之间的夹角。
金属会吸收透射光，这意味着它们不具有本体反射率。虽然如此，但金属并不会看上去表现为纯黑色，因为它们的Rf(0)值较高，也就是说，就算是在接近于0度这样极小的入射角度上，它们也能反射可观的镜面光量。

8.7.2 表面粗糙度
真实世界中的反射物体往往不是理想镜面。随着粗糙度的增加，微观表面法线的方向开始纷纷偏离宏观表面法线，由此反射光逐渐扩展为一个镜面瓣。
为了用数学方法对粗糙度进行建模，我们采用了微平面模型。在此模型中，我们将微观表面模拟为由多个即微小又平滑的微平面所构成的集合，而微观表面法线正是这些微平面上的法线。
针对指定的观察单位向量v以及光向量L，我们需要了解由L向v反射的所有微平面片段的分布情况；换言之，即法线为h=normalize(L+v)这种微平面片段在所有微平面中所占比例。
这样一来，就可以确定有多少光通过镜面反射的方式，以此路径进入到观察者的眼中，发生由L到v反射过程的微平面越多，则观察者在此角度上看到的镜面光越明亮。
由于向量h位列向量L与向量v间的中间位置，故称之为中间向量。此外，还要再引进一个中间向量h与宏观表面法线n之间的夹角θ。
我们定义归一化分布函数0<=p(θ)<=1，用来表示微观表面法线h与宏观表面法线n之间夹角为θ的微平面的分布情况。从直观上来讲，我们希望θ=0时，函数取得最大值。
用来模拟以上讨论中期望模型p(θ)的一种较流行的可控函数为：
(函数公式)
我们可以将p(θ)与某种归一化因子进行组合，从而获得基于粗糙度来模拟镜像反射光量的新函数：
(函数公式)
(菲涅尔反射以及表面粗糙度组合后的计算公式)

8.8 光照模型的概述
表面反射的光量相当于环境反射光，漫反射光以及镜面反射光的光量总和。
环境光：模拟经表面反射的间接光量；
漫反射光：对进入介质内部，又经过表面下吸收而最终散射出表面的光进行模拟。
镜面光：模拟经菲涅尔效应与表面粗糙度共同作用的表面反射光
(着色器中实现光照方程)

8.9 材质的实现
(Material结构体代码)
(BuildMaterials代码)
(其他代码见书本)

8.10 平行光源
由于光源距离物体十分遥远，我们忽略距离带来的影响，仅指定照射到场景中的光线的光强。

8.11 点光源
我们定义光向量与光传播方向相反。
在物理学中，光强会根据平方反比定律而随着距离函数发生衰减。
(光强公式)
然而，我们在这里却要使用一种更为简单的公式，这便是我们所用的线性衰减函数：
(衰减函数)

8.12 聚光灯光源
从本质上来说，聚光灯由位置Q向方向d照射出范围呈圆锥体的光。
光向量：L=(Q-P)/|Q-P|
P是被照点的位置，Q是聚光灯的位置。
位于圆锥体中心处的光线的光强应该是最强的，而随着角θ由0增加至θmax，光强会逐渐趋近于0。
(θ与光强之间的关系公式)
方向光计算最廉价，电光次之，聚光灯最昂贵。

8.13 光照的具体实现
8.13.1 Light结构体
(d3dUtil.h中Light结构体和LightingUtil.hlsl中对应的结构体)
结构体Light中的数据成员的排列顺序并不是随意指定的，这要遵从HLSL的结构体封装规则。(详情见附录B)
这条HLSL规则的大意是以填充对齐的方式，将结构体中的元素打包为4D向量。另外，单个元素不能以一分为二的方式分到两个4D向量之中。

8.13.2 常用辅助函数
下面3个函数定义于LightingUtil.hlsl文件中：
CalcAttenuation:实现了一种线性衰减因子的计算方法，可将其应用于点光源与聚光灯光源。
SchlickFresnel:代替菲涅尔方程的石里克近似。
BlinnPhong:计算反射到观察者眼中的光量，该值为漫反射光量与镜面反射光量的总和。
(3个函数的源码)

8.13.3 实现方向光源
给定观察位置E，材质属性，与以n为法线的表面上可见一点p，则下列HLSL函数将输出自某方向光源发出，经上述表面以方向v=normalize(E-p)反射入观察者眼中的光量。
(函数代码)

8.13.4 实现点光源
给出观察点E，以n作为法线的表面上可视一点p以及材质属性，则下面的HLSL函数将会输出从点光源放出，经上述表面在v = normalize(E-p)方向反射入观察者眼中的光量。
(函数代码)

8.13.5 实现聚光灯光源
指定观察点E，以n为法线的表面上可视一点p以及材质属性，则下面的HLSL函数将会输出来自聚光灯光源，经过上述表面以方向v=normalize(E-p)反射入观察者眼中的光量。
(函数代码)

8.13.6 多种光照的叠加
光强是可以叠加的。因此，在支持多个光源的场景中，我们需要遍历每一个光源，并把它们在我们要计算光照的点或像素上的贡献值求和。
代码所采用的约定是方向光源必须位于光照数组的开始部分，点光源次之，聚光灯光源排在末尾。
(计算光照的方程)

8.13.7 HLSL主文件
下面的代码含有本章演示程序中所用的顶点着色器与像素着色器，而其中所涉及的LightingUtil.hlsl文件中的HLSL代码。
(源码)

8.14 光照演示程序
8.14.1 顶点格式
8.14.2 计算法线
8.14.3 更新光照的方向
8.14.4 更新根签名
(例子源码)










8 光照
8.1 光照与材质的交互
在开启光照的同时，我们不再直接指出顶点的颜色，而是指定材质与光照，再运用光照方程基于两者的交互来计算顶点颜色。
我们可以把材质看作是确定光照与物体表面如何进行交互的属性集。
根据三色论，视网膜含有3种光受体，分别对于红绿蓝三色光敏感。
在本书中所采用的光照模型均为局部光照模型。若使用这种局部模型，则每个物体的光照皆独立于其他物体，我们也就可以在处理光照的过程中仅考虑光源直接发出的光线。
全局光照模型除了要考虑由光源直接发出的光，还要顾及场景中其他物体所反弹来的间接光照。另外一种流行的方法是预计算静态物体的间接光照，再用得到的结果来近似地模拟动态物体的间接光照。

8.2 法向量
平面法线是一种描述多边形朝向的单位向量。
曲面法线是一种垂直于曲面上一点处切平面的单位向量。根据曲面法线即可确定对应曲面上某点的朝向。
对于光照计算来说，我们需要通过三角形网格曲面上每一点处的曲面法线来确定光线照到对应点上的角度。
为了求出曲面法线，我们仅先指定位于网格顶点处的曲面法线。接下来，为取得三角形网格曲面上每个点处的近似曲面法线，在三角形进行光栅化的过程中对这些顶点法线进行插值计算。

8.2.1 计算法向量
三角形p0p1p2的平面法线:
u = p1 - p0; v = p2 - p0; n = u x v / |u x v|
对于可微的光滑曲面而言，我们可以利用微积分方面的知识来求出曲面点处的法线。但问题在于，三角形网格运用一种被称为求顶点法线平均值的计算方法。
此方法通过对网格中共享顶点v的多边形的平面法线求取平均值，从而获得网格中任意顶点v处的顶点法线n。
网格中的四个多边形公用顶点v的法线求法：
n = (n0+n1+n2+n3)/|n0+n1+n2+n3|
为了得到更为精确的效果，我们还可以采用更加复杂的求平均值方法，比如说，根据多边形的面积来确定权重，以求取加权平均值。

8.2.2 变换法向量
通过B=(A-1)T的法向量进行变换后，即可使它村子与经矩阵A变换后的切向量uA。
如果矩阵A是正交矩阵，我们无需再计算它的逆转置矩阵，利用正交矩阵A自身即可实现这一变换。
当我们需要经过非等比变换或剪切变换后的法向量进行变换时，则可使用逆转置矩阵。
尽管使用了逆转置变换，但法向量仍可能会失去其单位长度。

8.3 参与光照计算的一些关键向量
E是观察者的观察位置，我们现在来考察：在观察点p处颜色单位向量v所定义的视线来进行观察的过程。
位于表面的点p处有法线n，光线由入射方向I照射到点p。光向量L为单位向量，其所指方向与照射到表面上点p处入射光线I的方向刚好相反。
尽管在工作中使用光的入射方向I可能更为直观，但为了进行光照计算，我们还是采用法向量L。
对于朗伯余弦定律而言，向量L用于计算Ln=cosθ。反射向量r是入射向量L关于表面法线n的镜像。
反射向量的定义为r=I-2(nI)n，然而我们在着色器中实际是利用内置的reflect来计算r的。

8.4 朗伯余弦定律
我们可以将光看作是光子的集合，在空间中按特定的方向传播。每个光子都载有光能量。光源每秒发出的光能量称为辐射通量。
而单位面积上的辐射通量密度(辐照度)是一种很重要的概念。
光线垂直照射到表面的强度要大于以某个角度照射到表面的强度。试想有一小束辐射通量为P且横截面面积为A1的光束。
如果将此光束怎么垂直打向表面，则光束照射到表面上的面积为A1，而A1内的辐照度为E1=P/A1。
现假设转动光源，使光束以某个入射角度照射到表面上，则光束将覆于表面上的更大面积A2。此时，该面积的辐照度为E2=P/A2.
E2 = E1cosθ = E(nL)
换句话说，面积A2内辐照度就相当于将受垂直方向光照的面积A1内辐照度按比例nL=cosθ进行缩放。这就是传说中的朗伯余弦定律。
考虑到光线照射到表面另一侧的情况，我们用max函数来限制取值范围：
f(θ) = max(cosθ, 0) = max(Ln,0)


8.5 漫反射光照
当光线照射到表面上的某一点时，一部分光会进入物体的内部，并与表面附近的物质相互作用。这些光会在物体内部四处反弹，其中一部分会被吸收，而余下的部分则会向各个方向散射并返回表面，这就是漫反射。
我们规定光线会在表面的所有方向上均匀散射，因此，无论从哪个观察点进行观察，反射光都会进入观察者的眼中。
设BL表示入射光量，md为漫反射反照率，L为光向量，而n为表面法线，则位于表面上某点处的漫反射光量为:
cd = max(L . n,0) . BL x md

8.6 环境光照
环境光照：
ca = AL x md
这个模型的总体思路是：间接光照在场景中会发生多次的散射与反射，并会在所有方向上均等的射向目标物体。
光进入介质，发生反射，部分光被吸收，而剩下的光则向介质外的各个方向散射。第二种反射的发生是根据一种名为菲涅尔效应的物理现象。
如果折射光沿折射向量从介质的另一侧射出，并进入观察者的眼中，则该物体看起来就像是透明的。
从表面反射和进入眼睛的光量是由物体的漫反射光和镜面光所构成的。
与漫反射光相比，镜面光可能并不会射入观察者的眼内，因为其反射只发生在某一特定角度。
镜面光照的计算与观察点有关。同时，这意味着随着观察位置在场景中的移动，它收到的镜面光照也将随之改变。

8.7.1 菲涅尔效应
反射的光量即依赖于介质，也与法向量n与光向量L之间的夹角θ有关。
由于光照过程的复杂性，我们一般不会将完整的菲涅尔方程用于实时渲染，而是采用石里克近似法来代替：
RF(θ) = RF(0) + (1-RF(0))(1-cosθ)5次方
RF(0)是介质的一种属性。
水是(0.02,0.02,0.02) 玻璃(0.08,0.08,0.08)
向下俯视池塘，我们基本可以清楚地看到其底部沉积的沙石。这是由于有从周围环境中照射到池水的光以接近于0度的小角度θ反射进我们的眼睛而造成的。此时，反射到我们眼中的光量相对较低。
如果我们向远处望去，将会看到池水极强的反射光，这是因为有从周围环境中射向水的光以接近90度的角度反射进我们的眼中，从而增加了反射光量。
这种现象通常称为菲涅尔效应，可以将菲涅尔效应间接地概括为：反射光量取决于材质以及法线与光向量之间的夹角。
水，红宝石和铁，3种不同材质的石里克近似曲线图。

8.7.2 表面粗糙度
真实事件的反射物体往往不是理想镜面。尽管一个物体的表面看起来十分光滑，但从微观水平上看，它还是具有一定的粗糙度。
随着粗糙度增加，微观表面法线的方向开始纷纷偏离宏观表面法线，由此反射光逐渐扩展为一个镜面瓣。
为了用数学方法对粗糙度进行建模，我们采用了微平面模型。
在此模型中，我们将微观表面模拟为由多个既微小又平滑的微平面所构成的集合，而微观表面法线正是这些微平面上的法线。
针对指定的观察单位向量v以及光向量L，我们需要了解由L向v反射的所有微平面片段的分布情况；换言之，即法线为h=normalize(L+v)这种微平面片段在所有微平面中所占比例。
发生由L到v反射过程的微平面越多，则观察者在此角度上看到的镜面光越明亮。
由于向量h位列向量L与向量v间的中间位置，故称之为中间向量。此外，还要再引进一个中间向量h与宏观表面法线n之间的夹角θ。
我们定义归一化分布函数p(θ)，用来表示微观表面法线h与宏观表面法线n之间夹角为θ的微平面分布情况。
从直观上来讲，我们希望函数在θ=0时取得最大值。一种较流行的可控函数为：
p(θ) = cosm次方(θ) = cosm次方(n.h) m表示粗糙度
随着m的减小，表面变得更加粗糙，而微平面的法线也都愈加偏离宏观表面法线。
我们将p(θ)与某种归一化因子进行组合，从而获得基于粗糙度来模拟镜像反射光量的新函数:
S(θ) = (m+8) / 8 cosm次方(θ) = (m+8)/8( n h )m次方
对于较小的m值来说，表面会更加粗糙。
把菲涅尔反射以及表面粗糙度这两个公式的组合作为这一节的结尾。
c = max(L.n, 0).BL x RF(ah)(m+8)/8(n.h)m次方
ah为光向量v与中间向量h之间的夹角，RF(ah)反映了关于h射入v的反射光量。

8.8 光照模型的概述
表面反射的光量相当于环境反射光，漫反射光以及镜面反射光的光量总和。
LitColor = ca + cd + cs
= AL x md + max(L.n, 0).BL x (md + RF(ah)(m+8)/8(n.h)m次方)
以上所有向量均为单位长度：
L:指向光源的光向量；
n:表面法线
h:列于光向量与观察向量之间的中间向量
AL：表示入射的环境光量
BL：入射的直接光量
md:根据表面漫反射率而反射的入射光量
L.n:朗伯余弦定律
ah:中间向量h与光向量L之间的夹角
RF(ah):根据菲涅尔效应，关于中间向量h所反射到观察者眼中的光量
m:控制表面的粗糙度
(m.h)m次方：指定法线h与宏观表面法线n之间夹角为θ的所有微平面分段的分布情况(所占比例)。
m+8/8:镜面反射过程中，为模拟能量守恒所采用的归一化因子。


8.9 材质的实现
我们所编写的材质结构体定义在d3dUtil.h文件中，部分代码如下：

8.10 平行光源
由于光源距离物体十分遥远，我们忽略距离带来的影响，仅指定照射到场景中的光线的光强。

8.11 点光源
我们定义光向量与光传播方向相反。
在物理学中，光强会根据平方反比定律而随着距离函数发生衰减。
(光强公式)
然而，我们在这里却要使用一种更为简单的公式，这便是我们所用的线性衰减函数：
(衰减函数)

8.12 聚光灯光源
从本质上来说，聚光灯由位置Q向方向d照射出范围呈圆锥体的光。
光向量：L=(Q-P)/|Q-P|
P是被照点的位置，Q是聚光灯的位置。
位于圆锥体中心处的光线的光强应该是最强的，而随着角θ由0增加至θmax，光强会逐渐趋近于0。
(θ与光强之间的关系公式)
方向光计算最廉价，电光次之，聚光灯最昂贵。

8.13 光照的具体实现
8.13.1 Light结构体
(d3dUtil.h中Light结构体和LightingUtil.hlsl中对应的结构体)
结构体Light中的数据成员的排列顺序并不是随意指定的，这要遵从HLSL的结构体封装规则。(详情见附录B)
这条HLSL规则的大意是以填充对齐的方式，将结构体中的元素打包为4D向量。另外，单个元素不能以一分为二的方式分到两个4D向量之中。

8.13.2 常用辅助函数
下面3个函数定义于LightingUtil.hlsl文件中：
CalcAttenuation:实现了一种线性衰减因子的计算方法，可将其应用于点光源与聚光灯光源。
SchlickFresnel:代替菲涅尔方程的石里克近似。
BlinnPhong:计算反射到观察者眼中的光量，该值为漫反射光量与镜面反射光量的总和。
(3个函数的源码)

8.13.3 实现方向光源
给定观察位置E，材质属性，与以n为法线的表面上可见一点p，则下列HLSL函数将输出自某方向光源发出，经上述表面以方向v=normalize(E-p)反射入观察者眼中的光量。
(函数代码)

8.13.4 实现点光源
给出观察点E，以n作为法线的表面上可视一点p以及材质属性，则下面的HLSL函数将会输出从点光源放出，经上述表面在v = normalize(E-p)方向反射入观察者眼中的光量。
(函数代码)

8.13.5 实现聚光灯光源
指定观察点E，以n为法线的表面上可视一点p以及材质属性，则下面的HLSL函数将会输出来自聚光灯光源，经过上述表面以方向v=normalize(E-p)反射入观察者眼中的光量。
(函数代码)

8.13.6 多种光照的叠加
光强是可以叠加的。因此，在支持多个光源的场景中，我们需要遍历每一个光源，并把它们在我们要计算光照的点或像素上的贡献值求和。
代码所采用的约定是方向光源必须位于光照数组的开始部分，点光源次之，聚光灯光源排在末尾。
(计算光照的方程)

8.13.7 HLSL主文件
下面的代码含有本章演示程序中所用的顶点着色器与像素着色器，而其中所涉及的LightingUtil.hlsl文件中的HLSL代码。
(源码)

8.14 光照演示程序
1，陆地的法线计算
2，波浪的顶点数据
3，材质
4，光照计算





